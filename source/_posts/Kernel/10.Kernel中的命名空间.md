---
title: Kernel中的命名空间
tags:
  - Kernel
categories:
  - Kernel
abbrlink: 99e7a00f
date: 2022-03-24 21:39:13
---

# 命名空间

Linux Namespace是Kernel的一个功能，它可以隔离一系列的系统资源，如PID、User Id、Network等等。



# 命名空间描述

一个进程可以属于多个namespace，在`task_struct`结构体中有一个指向namespace结构体的指针。

```c
struct task_struct {
    ...
    /* Namespaces: */
	struct nsproxy			*nsproxy;
	...
}
```

`nsproxy`在文件`include/linux/nsproxy.h`的定义如下：

```c
/*
 * A structure to contain pointers to all per-process
 * namespaces - fs (mount), uts, network, sysvipc, etc.
 *
 * The pid namespace is an exception -- it's accessed using
 * task_active_pid_ns.  The pid namespace here is the
 * namespace that children will use.
 *
 * 'count' is the number of tasks holding a reference.
 * The count for each namespace, then, will be the number
 * of nsproxies pointing to it, not the number of tasks.
 *
 * The nsproxy is shared by tasks which share all namespaces.
 * As soon as a single namespace is cloned or unshared, the
 * nsproxy is copied.
 */
struct nsproxy {
	atomic_t count;
	struct uts_namespace *uts_ns;
	struct ipc_namespace *ipc_ns;
	struct mnt_namespace *mnt_ns;
	struct pid_namespace *pid_ns_for_children;
	struct net 	     *net_ns;
	struct time_namespace *time_ns;
	struct time_namespace *time_ns_for_children;
	struct cgroup_namespace *cgroup_ns;
};
```

多个进程可以使用同一个namespace，所以nsproxy可以共享使用，count字段是该结构的引用计数。

系统中有一个默认的nsproxy，该结构在task初始化的时候也会被初始化，定义在`init/init_task.c`:

```c
/*
 * Set up the first task table, touch at your own risk!. Base=0,
 * limit=0x1fffff (=2MB)
 */
struct task_struct init_task = {
    ...
    .nsproxy	= &init_nsproxy,
    ...
}
```

`init_nsproxy`的定义为：

```c
struct nsproxy init_nsproxy = {
	.count			= ATOMIC_INIT(1),
	.uts_ns			= &init_uts_ns,
#if defined(CONFIG_POSIX_MQUEUE) || defined(CONFIG_SYSVIPC)
	.ipc_ns			= &init_ipc_ns,
#endif
	.mnt_ns			= NULL,
	.pid_ns_for_children	= &init_pid_ns,
#ifdef CONFIG_NET
	.net_ns			= &init_net,
#endif
#ifdef CONFIG_CGROUPS
	.cgroup_ns		= &init_cgroup_ns,
#endif
#ifdef CONFIG_TIME_NS
	.time_ns		= &init_time_ns,
	.time_ns_for_children	= &init_time_ns,
#endif
};
```

对`.mnt_ns`没有初始化，其余的namespace都进行了系统默认的初始化。

# 命名空间创建

新的namespace可以使用以下两种方法创建：

1. 在用fork或clone系统调用创建新进程时，有特定的选项可以控制是否与父进程共享命名空间，或者建立新的命名空间。
2. unshare系统调用将进程的某些部分从父进程分离，其中页包括namespace。

在fork或clone系统调用创建新进程时，有特定的选项可以控制是否与父进程共享命名空间。选项如下：

- CLONE_NEWPID 空间内独立分配PID，命名空间内的PID可以与命名空间外的PID冲突。
- CLONE_NEWIPC 进程间通信的命名空间。
- CLONE_NEWNET 网络命名空间，用于隔离网络资源。后台进程可以运行在不同的命名空间内，还可以虚拟一块网卡。
- CLONE_NEWNS 挂载命名空间，进程运行时可以将挂载点与系统分离，可以达到chroot的功能，而在安全方面，比chroot更高。
- CLONE_NEWUTS UTS命名空间，主要目的是独立出主机名和网络信息服务（NIS）
- CLONE_NEWUSER 用户命名空间，同进程ID一样，用户ID和组ID在命名空间内外是不一样的，并且在不同的命名空间可以出现不同的ID。
