---
title: 运行扇区外的程序
tags:
  - 操作系统
categories:
  - 操作系统
cover: 'https://img.ansore.de/2022/04/27/62692c1359d83.jpg'
abbrlink: 2c89a838
date: 2022-01-05 12:23:19
---

# 运行扇区外的程序

目标：使启动扇区的BootLoader程序可以启动普通扇区内的程序

![Screenshot_20220112_222729.png](https://img.ansore.de/2022/05/15/6280e4d57ac05.png)

# BootLoader启动扇区

![Screenshot_20220112_223010.png](https://img.ansore.de/2022/05/15/6280e4d80b3a3.png)

所以程序需要准备一份“简历”，告诉BootLoader，BootLoader才能正确读取、加载并运行程序。这段程序要放到最前面，好让BootLoader读取第一个扇区后，就能获知所有的信息

![Screenshot_20220112_223428.png](https://img.ansore.de/2022/05/15/6280e4d9aef39.png)

而对于BootLoader，结构为：

![Screenshot_20220112_223503.png](https://img.ansore.de/2022/05/15/6280e4db70ead.png)

# Code

Program.asm

```
HDDPORT equ 0x1f0

section code align=16 vstart=0x7c00
  mov si, [READSTART]
  mov cx, [READSTART+2]
  mov al, [SECTORNUM]
  push ax
  ;Setup the destnation
	mov ax, [DESTMEN]
	mov dx, [DESTMEN+0x02]
  mov bx, 16
  div bx
  
  mov ds, ax
  xor di, di
  pop ax
  ;read the first sector
  call ReadHDD

  ResetSegment:
  mov bx, 0x04
  mov cl, [0x10]

  .reset:
  mov ax, [bx]
  mov dx, [bx+2]
  add ax, [cs:DESTMEN]
  adc dx, [cs:DESTMEN+2]

  mov si, 16
  div si
  mov [bx], ax
  add bx, 4
  loop .reset

  ResetEntry:
  mov ax, [0x13]
  mov dx, [0x15]
  add ax, [cs:DESTMEN]
  adc dx, [cs:DESTMEN+2]

  mov si, 16
  div si

  mov [0x13], ax

  jmp far [0x11]
ReadHDD:
  push ax
  push bx
  push cx
  push dx

  mov dx, HDDPORT+2
  out dx, al

  mov dx, HDDPORT+3
  mov ax, si
  out dx, al

  mov dx, HDDPORT+4
  mov al, ah
  out dx, al

  mov dx, HDDPORT+5
  mov ax, cx
  out dx, al

  mov dx, HDDPORT+6
  mov al, ah
  mov ah, 0xe0
  or al, ah
  out dx, al

  mov dx, HDDPORT+7
  mov al, 0x20
  out dx, al

  .waits:
  in al, dx
  and al, 0x88
  cmp al, 0x08
  jnz .waits

  mov dx, HDDPORT
  mov cx, 256

  .readword:
  in ax, dx
  mov [ds:di], ax
  add di, 2
  ;or ah, 0x00
  ;jnz .readword
  loop .readword
  .return:
  pop dx
  pop cx
  pop bx
  pop ax

  ret

READSTART dd 1
SECTORNUM db 1
DESTMEN   dd 0x10000

End: jmp End
times 510-($-$$) db 0
                 db 0x55, 0xaa
```

BootLoader.asm

```
NUL equ 0x00
SETCHAR equ 0x07
VIDEOMEM equ 0xb800
STRINGLEN equ 0xffff

section head align=16 vstart=0
  Size dd ProgramEnd ; 4B 0x00
	SegmentAddr:
  CodeSeg dd section.code.start ;4B 0x04
	DataSeg dd section.data.start ;4B 0x08
	StackSeg dd section.stack.start ;4B 0x0c
	SegmentNum:
	SegNum db (SegmentNum-SegmentAddr)/4 ;1B 0x10
	Entry dw CodeStart ;2B 0x11
	      dd section.code.start ;4B 0x13

section code align=16 vstart=0
CodeStart:
  mov ax, [DataSeg]
	mov ds, ax
	xor si, si
	call PrintString
	jmp $

PrintString:
  .setup:
  push ax
  push bx
  push cx
  push dx
  mov ax, VIDEOMEM
  mov es, ax
  xor di, di

  mov bh, SETCHAR
  mov cx, STRINGLEN

  .printchar:
  mov bl, [ds:si]
  inc si
  mov [es:di], bl
  inc di
  mov [es:di], bh
  inc di
  or bl, NUL
  jz .return
  loop .printchar
  .return:
  mov bx, di
  pop dx
  pop cx
  pop bx
  pop ax
  ret

section data align=16 vstart=0
  Hello db 'Hello, I come from program on sector 1, loaded by bootloader!'

section stack align=16 vstart=0
  ; resb 保留一定空间
  resb 128

section end align=16
  ProgramEnd:
```

运行结果

![Screenshot_20220112_225338.png](https://img.ansore.de/2022/05/15/6280e4e03d18e.png)
