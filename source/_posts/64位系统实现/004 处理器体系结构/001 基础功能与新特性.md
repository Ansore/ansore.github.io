---
title: 64位操作系统-处理器架构
tags:
  - 64位系统实现
  - 操作系统
categories:
  - 操作系统
cover: 'https://img.ansore.top/2022/09/11/f01cf15d850f0ce8f2c97c93a206411c8d3bf927.png'
abbrlink: 466215f
date: 2022-09-14 09:26:11
---

# 运行模式

- 实模式
- 保护模式。32位处理器的主要模式。
- 系统管理模式。
- 虚拟8086模式
- IA-32e模式。64位吃处理器的主要运行模式。

体系结构各运行模式间切换过程：

![Screenshot_20220912_203300](https://img.ansore.top/2022/09/12/3b13f20d9cb2462c00546ac43816fe9e.png)

处理器上电或重启之后首先运行实模式。`CR0`控制寄存器的PE标志位控制处理器运行在实模式或者保护模式。`EFLAGS`标志寄存器的`VM`标志位可使处理器在保护模式可使处理器在保护模式与虚拟8086模式间切换，切换过程往往通过任务切换或中断/异常返回程序实现。 在开启分页机制的保护模式下，置位`IA32-EFER`寄存器的`LME`标志位（位于`IA32-EFER`寄存器的第8位）可使处理器进入`IA-32e`模式。通过`IA32-EFER`寄存器的`LMA`标志位（位于`IA32-EFER`寄存器的第10位）可以判断处理器是否运行在`IA-32e`模式下。当前处理器运行与`IA-32e`模式，代码段描述符的`L`标志位可确定处理器运行于64位模式还是兼容模式。不管处理器正处于什么模式，一旦收到`SMI`信号便会进入`SMM`模式。只有在执行`RSM`指令后，处理器会返回到产生`SMI`信号前。

# 通用寄存器

`IA32`体系下的通用寄存器有`EAX`、`EBX`、`ECX`、`EDX`、`ESI`、`EDI`、`EBP`、`ESP`。`ESP`已被处理器用于保存栈指针值。

一些指令的执行必须依赖特定的寄存器。例如，`ECX`、`ESI`和`EDI`寄存器经常用于字符串指令操作，`DS`段寄存器经常使用`EBX`寄存器来保存段内偏移地址。

![Screenshot_20220912_211629](https://img.ansore.top/2022/09/12/2f046c9631c8077c70deaf74530c3f35.png)

在`IA-32e`体系结构的64位运行模式下，虽然通用寄存器的操作数模式是32位宽。但它们有能力支持64位宽的操作数。Intel公司在64位模式里加入了8个新的通用寄存器，因此处理器可使用`RAX`、`RBX`、`RCX`、`RDX`、`RSI`、`RBP`、`RSP`、`R8`\~`R15`这16个通用寄存器，其中的`R8`\~`R15`寄存器只在64位模式下有效。

# CPUID指令

`CPUID`指令用于鉴别处理器信息以及检测处理器支持的功能，它在任何模式下执行效果相同。通过`EFLAGS`标志寄存器的ID标志位（位于`EFLAGS`寄存器的第21位）可检测处理器是否支持`CPUID`指令。

`CPUID`指令使用`EAX`寄存器作为输入参数，也叫做主功能号。对于一些复杂的主功能来说，它可能会需要子功能号来辅助查询，此时`ECX`寄存器会向`CPUID`指令系统子功能号。`CPUID`指令执行结束后，`CPUID`指令会使用`EAX`、`EBX`、`ECX`、`EDX`寄存器保存执行结果。在64位模式下这些信息仍然是32位的，低32位有效，高32位清零。

`CPUID`指令可以查询两类信息：基础功能和扩展信息。基础信息主功能号从`0h`开始，目前处理器支持的最大主功能号是`14h`，处理器通过`CPUID`指令的主功能号`0h`可查询出处理器支持的最大基础功能号。扩展信息的主功能号从`80000000h`开始，目前处理器支持的最大主功能号是`80000008h`，处理器通过CPUID指令的主功能号`80000000h`可查询出处理器当前支持的最大扩展功能号。

![Screenshot_20220912_213406](https://img.ansore.top/2022/09/12/6226b8405f3ed9d617e3418c0797c31b.png)

# 标志寄存器EFLAGS

`EFLGAS`标志寄存器包含有状态标志位、控制标志位以及系统标志位，处理器在初始化时将`EFLGAS`标志寄存器赋值为`00000002h`。在`IA-32e`体系结构中，`EFLGAS`标志寄存器已从32位扩展为64位，其中高32位暂时保留。

![Screenshot_20220912_213731](https://img.ansore.top/2022/09/12/905aec8aea01cd1c56ce88c191fc82b3.png)

某些特殊的汇编指令可以直接修改`EFLGAS`标志寄存器的标志位。指令`LAHF`、`SAHF`、`PUSHF`、`PUSHFD`、`POPF`、`POPFD`可实现`EFLAGS`标志寄存器与栈（或`EAX`寄存器）的互相保存。一旦`EFLGAS`标志寄存器存有备份，程序便可以借助`BT`、`BTS`、`BTR`、`BTC`等指令对标志位进行修改或检测。当程序通过调用门执行任务切换时，处理器会把`EFLGAS`标志寄存器值保存到任务状态段 `TSS`内，并将目标任务状态段`TSS`内的值更新到`EFLGAS`标志寄存器中。

## 状态标志

`EFLGAS`标志寄存器的状态标志（0、2、4、6、7、11位）可以反映汇编指令计算结果的状态，如`ADD`、`SUB`、`MUL`、`DIV`等汇编指令计算结果的奇偶性、溢出状态、正负值等。

![Screenshot_20220912_214153](https://img.ansore.top/2022/09/12/7c2711b28b6798ef7a714d19f0e57c9a.png)

`CF`标志位可反映出有符号整型数计算结果的溢出状态，`AF`可反映BCD型整数计算结果的溢出状态，`SF`标志位可反映出有符号整型数计算结果的正负值，`ZF`标志位可反映整型数的计算结果。

以上标志位，只有`CF`标志位可通过`STC`、`CLC`、`CMC`汇编指令更改位值，它也可以借助位操作指令（`BT`、`BTS`、`BTR`、`BTC`指令）将指定位值复制到`CF`标志位。而且`CF`标志位还可在多倍精度整型数计算时，结合`ADC`（含进位的加法计算）或`SBB`指令（含借位的减法指令）将进位计算或借位计算扩展到下次计算中。

至于状态跳转指令`Jcc`、状态字节置位指令`SETcc`、状态循环指令`LOOPcc`以及状态移动指令`CMOVcc`，它们可将一个或多个状态标志位作为判断条件，条件分支跳转、字节置位以及循环计数。

## 方向标志

`DF`方向标志位位于`EFLAGS`标志寄存器的第10位，它控制字符串指令（如`MOVS`、`CMPS`、`SCAS`、`LODS`和`STOS`等）的操作方向。置位`DF`标志位可使字符串指令按从高到低的地址方向（自减）操作数据，复位`DF`标志位可使字符串指令按从低到高的地址方向（自增）操作数据。汇编指令`STD`与`CLD`可用于置位和复位`DF`方向标志位。

## 系统标志和IOPL区域

`EFLAGS`标志寄存器的系统标志和IOPL区域，负责控制I/O端口地址访问权限、屏蔽硬件中断请求、使能单步调试、任务嵌套以及使能虚拟8086模式等

![Screenshot_20220912_221521](https://img.ansore.top/2022/09/12/f349fcdfa07420537c4aa15fd64fad96.png)

如果希望修改系统标志位或IOPL区域，则必须拥有足够的执行权限（0特权级）。`VIF`和`VIP`标志只能在虚拟8086模式下有效；`AC`标志位只能对3特权级的数据对齐检测，如果发现数据未对齐则触发`#AC`异常；置位`RF`标志位将临时禁止断点触发`#DB`异常；`IF`标志位对`NMI`（Nonmaskable Interrupt，不可屏蔽中断）不起作用。可以借助汇编指令`CLI`、`STI`、`POPF`、`POPFD`、`IRET`操作IF标志位。

# 控制寄存器

控制寄存器功能表：

![Screenshot_20220912_222012](https://img.ansore.top/2022/09/12/d45ff10d8acb1d67c1f9404f2218e7b9.png)

IA-32体系结构下，控制寄存器位宽是32位，而IA-32e体系结构下位宽为64位

![Screenshot_20220912_222118](https://img.ansore.top/2022/09/12/2f0d05571695e63329be75867dceac60.png)

可通过`MOV CRn`汇编指令可对控制寄存器进行操作，其中的保留位必须写入数值0，否则会触发`#GP`异常。`CR2`和`CR3`寄存器不会对写入的地进行检测。`CR8`控制寄存器只在64位模式下有效。

各个有效标志位的功能说明：

![Screenshot_20220912_222410](https://img.ansore.top/2022/09/12/6ca56f852bd71d3e4ea92f8bd77e774e.png)

如果`CR0.PE=0`时，置位`CR0.PG`标志寄存器会触发`#GP`异常。`CR0.CD`与`CR0.NW`标志位会联合控制处理器的缓存和读写策略。

![Screenshot_20220912_222546](https://img.ansore.top/2022/09/12/bcf9ff5fb1d09ad373389ca2357d6521.png)

处理器的`CR0.TS`、`CR0.EM`以及`CR0.MP`标志位都用于控制浮点处理器（`x86 FPU`、`MMX`、`SSE`、`SSE2`、`SSE3`、`SSSE3`、`SSE4`等）的执行动作。

![Screenshot_20220912_222740](https://img.ansore.top/2022/09/12/0455c9cce12d5a340d887af444748323.png)

标志位`TS`、`EM`、`MP`对`MMP`、`SSE`、`SSE2`、`SSE3`、`SSSE3`以及`SSE4`指令的影响会更复杂一些。

除`CRn`控制寄存器和`XCR0`扩展控制寄存器（用于控制浮点计算功能）外，`EFER`寄存器也用于控制系统功能。它是`MSR`控制寄存器组的`IA32_EFER`寄存器，它提供了控制`IA-32e`运行模式开启的标志位，以及关于页表访问限制的控制区域。

![Screenshot_20220912_223143](https://img.ansore.top/2022/09/12/9ba53f327c55f30afaa2dc943a046d7d.png)

其中`LME`标志位最为重要，它用于开启IA-32e模式，而第0位则是`SYSCALL/SYSRET`指令的使能位。

![Screenshot_20220912_223256](https://img.ansore.top/2022/09/12/fa309b62ba0c7b6c948aea33b45b6484.png)

# MSR寄存器组

MSR寄存器组可提供性能检测、运行轨迹跟踪与调试以及其他处理器功能。在使用MSR寄存器组之前，应该通过`CPUID.01h:EDX[5]`来检测处理器是否支持MSR寄存器组。每种处理器都有自己的MSR寄存器组，在使用MSR寄存器组前需要根据处理器的家族信息（`CPUID.01h`查询处理器家族信息）选择与相对应的MSR寄存器组。

处理器可以使用`RDMSR`和`WRMSR`对MSR寄存器组进行访问，整个访问过程借助ECX寄存器索引寄存器地址，再由`EDX:EAX`组成的64位寄存器保存访问值。（64位模式下，`RCX`、`RAX`和`RDX`寄存器的高32位会被忽略）而且这对指令必须在实模式或0特权级下执行，否则将会触发`#GP`异常，使用MSR寄存器组的保留地址或无效地址都会产生通用保护异常。

通常`IA32_EFER`寄存器位于地址`0c0000080h`处，`SYSENTER/SYSEXIT`指令相关配置寄存器通常在地址`174h`、`175h`和`176h`处。这些寄存器地址可能根据处理器家族不同而变化。
